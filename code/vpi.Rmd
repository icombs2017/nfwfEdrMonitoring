---
title: "NFWF VPI"
author: "Ian Combs -- icombs@mote.org"
output:
  html_document:
    theme: flatly
    code_folding: show
    toc: yes
    toc_depth: 3
    toc_float: yes
  pDf_doctument:
      toc: yes
      toc_depth: 3
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, fig.align = 'left')
library(magrittr)
```

### version: `r Sys.Date() %>% format(format="%B %d, %Y")`

<!-- this is where the DOI would go  [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.3675991.svg)](https://doi.org/10.5281/zenodo.3675991)
-->


#### [GitHub repository](https://github.com/icombs2017/photogrammetryNOAA.git){target="_blank"}

###
+++
This is the analysis pipeline for data generated from TagLab annotations of our EDR outplant sites as part of the NWFW project.


+++
### All analyses performed with R verion `r getRversion()`
# Basic setup of R environment
+++
## Loading required packages

For the following analyses we will require the use of a number of different R packages. Most of which can be sourced from CRAN, but some must be downloaded from GitHub. We can use the following code to load in the packages and install any packages not previously installed in the R console. 

```{r, load packages, include = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load("ggplot2","officer","ggpubr", "rcompanion", "RColorBrewer", "magrittr","reshape2", "stringr", "plyr", "dplyr", "flextable", "tidyr", "tibble", "vegan", "forcats", "readr", "metafolio", "FSA","viridis", "paletteer", "purrr", "data.table", "ecodist", "glue", "gtools", "patchwork", "lme4", "lmerTest")
pacman::p_load_gh("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
```

<br><br>

# Loading Data
+++

Data is exported from Viscore's VPI scriplet as a .csv file and named according to the file. 
Since Viscore puts the "percent" column as a percentage sign (++%++) R cannot read it in  we are using `dplyr`'s `rename` function to change it to something R can read and that is easier to call and read when we are handling the data. Before we manipulate the data I am first making a vector called ++myColors++ using the function `gg_color_hue()` from the package `metafolio` that will save a vector of colors to the number of factors I have, this is so in our later plots, all the color palettes will be the same. I am also adding ++site++ and ++time++ columns to each subset, combining all subsets into one large dataframe using `bind_rows()`, adding a ++treatment++ column and using the `gsub()` to rename some 
```{r, load data, include = TRUE, results = 'hide'}


read_plus <- function(flnm) {
    read_csv(flnm) %>% 
        mutate(filename = flnm)
}

vpiData1 <-
    list.files(path = "../data/vpiData", pattern = "+.csv", 
               full.names = T) %>% 
    map_dfr(~read_plus(.))


#Sort out data to have proper columns for all the info i want, this might need to be changed to figure out the Marks vs Plot thing

vpiData2 <- vpiData1 %>% 
      tidyr::separate(filename, into=c("Date", "Site"),extra = 'merge',sep = "(?=T)") %>%
      tidyr::separate(Date, into=c("remove", "Date"),sep = "../data/vpiData/") %>% 
      tidyr::separate(Site, into = c("Site", "delete"),sep = ".pqs") %>% 
      dplyr::select(-c(remove, delete)) %>% 
      mutate_if(is.character, str_replace_all, pattern = "_", replacement = "-") %>%
      tidyr::separate(Date, into = c("Date", "remove"), sep = 10) %>% 
      dplyr::select(-remove) %>% 
      tidyr::separate(Site, into = c("Site", "Plot"), sep = "(?=plot)", extra = "merge") %>% 
      tidyr::separate(Site, into = c("Site", "Mark"), sep = "(?=mark)", extra = "merge") %>% 
      tidyr::separate(Plot, into = c("Plot", "Mark"), sep = "(?=mark)", extra = "merge" ) %>%
      mutate(species = if_else(grepl("AP", Site), "APAL", "ACER")) %>% 
      dplyr::rename(abundance = `%`) %>%
      tidyr::drop_na(abundance) %>% 
      arrange(desc(abundance))




#Changing the Date to factors
vpiData2$Date<-as.Date(vpiData2$Date)



#Making some corrections in the naming
vpiData3 <- vpiData2 %>%
  mutate_all(~gsub("Crustose coralline algae natans", "Crustose coralline algae", .)) %>%
  mutate_all(~gsub("Cordata", "Chordata", .)) %>%
  mutate_all(~gsub("Rubble", "Bare Substrate", .)) %>%
  mutate(Site = gsub("T-AP-7pt2", "T-AP-7", Site),
         Site = gsub("T-AP-7pt1", "T-AP-7", Site),
         Site = gsub("T-AP-17pt2", "T-AP-17", Site),
         Site = gsub("T-AP-17pt1", "T-AP-17", Site),
         Site = gsub("T-AP-16pt2", "T-AP-16", Site),
         Site = gsub("T-16pt1", "T-16", Site),
         Site = gsub("T-16pt2", "T-16", Site),
         Site = gsub("T-17pt1", "T-17", Site),
         Site = gsub("T-17pt2", "T-17", Site),
         Site = gsub("T-17pt3", "T-17", Site),
         Site = gsub("T-17pt4", "T-17", Site),
         Site = gsub("T-AP-13pt2", "T-AP-13", Site),
         Site = gsub("T-AP-13pt1", "T-AP-13", Site),
         Site = gsub("T-AP-14pt1", "T-AP-14", Site),
         Site = gsub("T-AP-14pt2", "T-AP-14", Site),
         Site = gsub("T-12a", "T-12", Site),
         Site = gsub("T-12b", "T-12", Site),
         Site = gsub("T-13a", "T-13", Site),
         Site = gsub("T-13b", "T-13", Site),
         Site = gsub("T-AP-3a", "T-AP-3", Site),
         Site = gsub("T-18pt1", "T-18", Site),
         Site = gsub("T-18pt2", "T-18", Site)
) %>%
  filter(!Site %in% c("T-19")) %>% 
  mutate_all(~gsub("Other|Review|None", NA, .))



# Changing other columns to factors

vpiData4 <- vpiData3 %>%
  mutate(across(c(Site, class, timePoint, species), as.factor)) %>%
  mutate(Date = as.Date(Date)) %>%
  mutate(count = as.numeric(count)) %>% 
  select(Date, Site, timePoint, species, class, count)


# Changing the factor level of timePoint to be chronological
vpiData <- vpiData4 %>%
  mutate(timePoint = factor(timePoint, levels = levels(timePoint)[c(2,1)]))
vpiData



```


<br><br>
# Combining Data
+++
Multiple VPI surveys were conducted in each site, so we are combining all of the sites and creating a new abundance column from that
```{r}

vpiData2 <- vpiData %>% 
  dplyr::filter(class != c("NA")) %>%
  droplevels() %>%
  group_by(Site,timePoint, species, class) %>% 
  dplyr::summarise(totalCount = sum(count)) %>%
  ungroup() %>% 
  group_by(Site,timePoint) %>% 
  dplyr::mutate(totalObservations = sum(totalCount, na.rm = TRUE)) %>%
  ungroup() %>% 
  group_by(Site,timePoint, class) %>% 
  dplyr::mutate(abundance = ((totalCount/totalObservations)*100))


vpiData2 <- data.table(vpiData2)
vpiData2[, `:=`(class, reorder(class, abundance))]
# vpiData2$class <- drop_na(vpiData2$class)



```


<br><br>
# Plotting the data
+++

To visualize the data and what our species composition looks like at our sites, we are going to plot the data in a few different ways. First we are going to just plot those with >1% abundance at our sites.



```{r, stackedBarGraphs, include = TRUE}

ACER <- vpiData2 %>%
  filter(species == "ACER") %>%
  filter(abundance > 1) %>%
  droplevels() %>%
  mutate(Site = factor(Site, levels = rev(mixedsort(levels(Site)))))

APAL <- vpiData2 %>%
  filter(species == "APAL") %>%
  filter(abundance > 1) %>%
  droplevels() %>%
  group_by(Site,timePoint, class) %>%
  dplyr::mutate(abundance = ((totalCount/totalObservations)*100)) %>%
  mutate(Site = factor(Site, levels = rev(mixedsort(levels(Site)))))



ACER <- vpiData %>% 
  dplyr::filter(class != c("NA")) %>%
  filter(species == "ACER") %>% 
  # filter(!class == "Bare Substrate") %>% 
  droplevels() %>%
  group_by(Site,timePoint, species, class) %>% 
  dplyr::summarise(totalCount = sum(count)) %>%
  ungroup() %>% 
  group_by(Site,timePoint) %>% 
  dplyr::mutate(totalObservations = sum(totalCount, na.rm = TRUE)) %>%
  ungroup() %>% 
  group_by(Site,timePoint, class) %>% 
  dplyr::mutate(abundance = ((totalCount/totalObservations)*100)) %>% 
  filter(abundance >1) %>% 
  mutate(Site = factor(Site, levels = rev(mixedsort(levels(Site))))) %>% 
  mutate(class = fct_reorder(class, desc(abundance)))





APAL <- vpiData %>% 
  dplyr::filter(class != c("NA")) %>%
  filter(species == "APAL") %>% 
  # filter(!class == "Bare Substrate") %>% 
  droplevels() %>%
  group_by(Site,timePoint, species, class) %>% 
  dplyr::summarise(totalCount = sum(count)) %>%
  ungroup() %>% 
  group_by(Site,timePoint) %>% 
  dplyr::mutate(totalObservations = sum(totalCount, na.rm = TRUE)) %>%
  ungroup() %>% 
  group_by(Site,timePoint, class) %>% 
  dplyr::mutate(abundance = ((totalCount/totalObservations)*100)) %>% 
  filter(abundance >1) %>% 
  droplevels() %>% 
  mutate(Site = factor(Site, levels = rev(mixedsort(levels(Site))))) %>% 
  mutate(class = fct_reorder(class, desc(abundance)))





acerStack1 <- ggplot(ACER, aes(x = timePoint, y = abundance))+
                      geom_bar(aes(fill = factor(class)), position = position_stack(reverse = FALSE), stat = 'identity', color = 'black', alpha = 0.8)+
                      ylim(0,100)+
                      labs(y = "Relative Abundance (%)", fill = "Class", title = "Relative Cover > 1%", x = "Time Point")+
  scale_x_discrete(labels = c("Baseline", "12 Month"))+
                      # scale_y_reverse()+
                      facet_wrap(.~Site, scales = 'free')





acerStack <- acerStack1 + theme(
    # Title
    plot.title = element_text(size = 40, face = "bold"), 
    # X Axis
    axis.text.x = element_text(size = 15, colour = "black", vjust = 0.5, hjust = 0.5, face= "bold"), 
    axis.title.x = element_blank(),
    # Y Axis
    axis.title.y = element_text(size = 40, face = "bold"), 
    axis.text.y = element_text(colour = "black", size = 30, face = "bold"),
    # Axis Lines and Ticks
    axis.line = element_line(colour = "black"), 
    axis.ticks = element_line(color="black"), 
    # Legend
    legend.title = element_text(size = 40, face = "bold"), 
    legend.text = element_text(size = 36, face = "bold", colour = "black"), 
    legend.position = "right",
    # Grid and Background
    panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
    panel.background = element_rect(fill = '#F5F5F5'), 
    # Text
    text = element_text(size=40, color="black"))



acerStack

apalStack1 <- ggplot(APAL, aes(x = timePoint, y = abundance))+
                      geom_bar(aes(fill = factor(class)), position = position_stack(reverse = FALSE), stat = 'identity', color = 'black', alpha = 0.8)+
                      ylim(0,100)+
                      labs(y = "Relative Abundance (%)", fill = "Class", title = "Relative Cover > 1%", x = "Time Point")+
  scale_x_discrete(labels = c("Baseline", "12 Month"))+
                      # scale_y_reverse()+
                      facet_wrap(.~Site, scales = 'free')





apalStack <- apalStack1 +theme(
    # Title
    plot.title = element_text(size = 40, face = "bold"), 
    # X Axis
    axis.text.x = element_text(size = 15, colour = "black", vjust = 0.5, hjust = 0.5, face= "bold"), 
    axis.title.x = element_blank(),
    # Y Axis
    axis.title.y = element_text(size = 40, face = "bold"), 
    axis.text.y = element_text(colour = "black", size = 30, face = "bold"),
    # Axis Lines and Ticks
    axis.line = element_line(colour = "black"), 
    axis.ticks = element_line(color="black"), 
    # Legend
    legend.title = element_text(size = 40, face = "bold"), 
    legend.text = element_text(size = 36, face = "bold", colour = "black"), 
    legend.position = "right",
    # Grid and Background
    panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
    panel.background = element_rect(fill = '#F5F5F5'), 
    # Text
    text = element_text(size=40, color="black"))
apalStack

# comboPlot <- acerStack + apalStack + plot_layout(guides = 'collect')


# ggsave("../figures/comboPlot.png", plot = comboPlot, width = 20, height = 15, units = 'in', dpi = 600)

ggsave("../figures/acerStackVPI.jpg", plot = acerStack, width = 20, height = 15, units = 'in', dpi = 600)
ggsave("../figures/apalStackVPI.jpg", plot = apalStack, width = 20, height = 15, units = 'in', dpi = 600)




```

# Analysis
We are making dissimilarity matrices in order to understand relatedness between outplant sites, events, etc and visualizing them in a few different ways including PCOAs and NMDSs with final statistical analysis being conducted as a Permuational Analysis of Variance (PERMANOVA) using the package `vegan` and the function `adonis2()`.
```{r, dissimilarityMatrix, include = TRUE}


vpiMat <- vpiData2 %>% 
  select(Site, timePoint, species, class, totalCount) %>% 
  group_by(Site, timePoint, species, class) %>%
  # dplyr::summarise(totalCount = sum(count)) %>%
  na.omit(class) %>% 
  tidyr::unite(sample, 1:3) %>% 
  spread(class,totalCount) %>%
  replace(is.na(.), 0) %>%
  column_to_rownames(var = 'sample')

dist_matrix <- as.matrix(bcdist(vpiMat),byrow = TRUE)


dist_tbl <- dist_matrix %>% 
        as_tibble(rownames = 'samples')

samples <- dist_tbl %>% 
  select(samples)


 samples_lookup <- dist_tbl %>% 
   select(samples) %>% 
   separate(col = samples, into = c("site", "timePoint", "species"), sep = "_", remove = FALSE)
 


  

dist_tbl %>% 
  pivot_longer(cols = -samples, names_to = "b", values_to = "distances") %>% 
  pivot_wider(names_from = "b", values_from = "distances")
 
 

dist_matrix <- dist_tbl %>%
  pivot_longer(cols=-samples, names_to="b", values_to="distances") %>%
  inner_join(., samples_lookup, by="samples") %>%
  inner_join(., samples_lookup, by=c("b" = "samples")) %>%
  # filter(day.x %in% days_wanted & day.y %in% days_wanted) %>%
  select(samples, b, distances) %>%
  pivot_wider(names_from="b", values_from="distances") %>%
  select(-samples) %>%
  as.dist()


```

```{r, PCoA, include = TRUE}


pcoa <- cmdscale(dist_matrix, k = 2, eig = TRUE, add = TRUE) # add k = 3, k = 5 to add columns, default is k=2
positions <- pcoa$points
colnames(positions) <- c("pcoa1", 'pcoa2')
# calculating the amount of variation explained by each dimension
percentExplained <- 100 + (pcoa$eig / sum(pcoa$eig))

#rounding and trimming to add to labels
RoundPercentExplained <- format(round(percentExplained[1:2], digits = 1), nsmall = 1, trim = TRUE)

# creating label vector
labs <- c(glue("PCo 1 ({RoundPercentExplained[1]}%)"),
          glue("PCo 2 ({RoundPercentExplained[2]}%)"))




treatmentCentroid <- positions %>% as_tibble(rownames='samples') %>%
  inner_join(., samples_lookup, by = 'samples') %>% 
  group_by(timePoint) %>% 
  dplyr::summarise(axis1 = mean(pcoa1),
            axis2 = mean(pcoa2))




#
pcoaTbl <- positions %>% as_tibble(rownames='samples') %>%
  inner_join(., samples_lookup, by = 'samples') 

pcoaPlot1 <- ggplot() +
  geom_point(data = pcoaTbl, mapping = aes(x = pcoa1, y = pcoa2, color = timePoint, shape = timePoint), size = 3) +
  geom_point(data = treatmentCentroid, mapping = aes(x = axis1, y = axis2, color = timePoint), shape = 15, size = 5) +
  labs(x = labs[1], y = labs[2])


pcoaPlot2 <- ggplot(pcoaTbl, aes(x = pcoa1, y = pcoa2, color = species, fill = species)) +
  stat_ellipse(geom = 'polygon', alpha = 0.2, level = 0.75, show.legend = FALSE) +
  geom_point(aes(x = pcoa1, y = pcoa2, shape = timePoint), alpha = 1, size = 3) +
  # geom_point(data = treatmentCentroid, mapping = aes(x = axis1, y = axis2, color = treatment), shape = 15, size = 5) +
  labs(x = labs[1], y = labs[2])

pcoaPlot1 <- pcoaPlot2 + theme(
    # Title
    plot.title = element_text(size = 40, face = "bold"),
    # X Axis
    axis.text.x = element_text(angle = 45, hjust = 1),  
    axis.title.x = element_text(size = 20, face = "bold"),
    # Y Axis
    axis.title.y = element_text(size = 20, face = "bold"),
    axis.text.y = element_text(colour = "black", size = 20, face = "bold"),
    # Axis Lines and Ticks
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(color="black"),
    # Legend
    legend.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 20, face = "bold", colour = "black"),
    legend.position = "bottom",
    # Grid and Background
    panel.grid.major = element_line(size = 0.3, linetype = 'solid', colour = "black"),
    panel.background = element_rect(fill = 'white'),
    # Text
    text = element_text(size=20, color="black"))


ggsave("../figures/pcoaPlot.png", plot = pcoaPlot1, width = 20, height = 15, units = 'in', dpi = 600)



tibble(pe = cumsum(percentExplained),
       axis = 1:length(percentExplained)) %>%
  ggplot(aes(x = axis, y = pe))+
  geom_line()+
  coord_cartesian(xlim = c(1,10))




```

```{r, NMDS, include = TRUE}

set.seed(3008)
nmds <- metaMDS(dist_matrix)

scores(nmds) %>% 
  as_tibble(rownames='samples') %>% 
  inner_join(., samples_lookup, by = 'samples') %>% 
  ggplot(aes(x = NMDS1, y = NMDS2, color = timePoint))+
  geom_point()
  




```

```{r, ecologicalDistances, include = TRUE}

ecoMat <- as.matrix(vpiMat)
samples_lookup <- vpiMat %>%
  rownames_to_column(var = 'samples') %>% 
   select(samples) %>% 
   separate(col = samples, into = c("site", "timePoint", "species"), sep = "_", remove = FALSE)


set.seed(3008)
dist <- vegdist(ecoMat, method = 'bray')
nmds <- metaMDS(dist)

scores(nmds) %>% 
  as_tibble(rownames = 'samples') %>%
  inner_join(., samples_lookup, by = 'samples') %>% 
  ggplot(aes(x = NMDS1, y = NMDS2, shape = timePoint, color = species))+
  geom_point()







```

```{r, PERMANOVA, include = TRUE, message = FALSE}

set.seed(9999)

vpiMat1 <- vpiMat %>% 
  select(-c(`Bare Substrate`))



 samplesLookupPerm <- vpiMat1 %>% 
   rownames_to_column(var = "samples") %>% 
   select(samples) %>% 
   separate(col = samples, into = c("site", "timePoint", "species"), sep = "_", remove = FALSE) %>% 
   column_to_rownames(var = "samples")
 
vpiDist <- vegdist(vpiMat1, method = 'bray')

distPerm <- adonis2(vpiDist ~ timePoint+species, data = samplesLookupPerm, permutations = 9999, method = 'bray')

distPerm



```




```{r, PERMANOVAtable, include = TRUE, results = hide}

distPermTab <- distPerm %>%
  as_tibble(rownames = "Comparison") %>%
  dplyr::rename("Pseudo.F" = "F", "p.value" = "Pr(>F)") %>% 
  select(Comparison, Df, `Pseudo.F`, `p.value`) %>% 
  mutate_if(is.numeric, round, digits = 3) %>%
  mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
  mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>% 
  mutate_if(is.character, str_replace_all, pattern = "-", replacement = "–") %>%
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>% 
  flextable::compose(part = "header", j = "Df", value = as_paragraph("Df")) %>% 
  flextable::compose(part = "header", j = "Pseudo.F", value = as_paragraph("Pseudo-F")) %>%
  flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>% 
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%  
  align(align = 'center', part = "footer")




distDoc = read_docx()
distDoc = body_add_flextable(distDoc, value = distPermTab)
print(distDoc, target = "../tables/distTableVpi.docx")
distPermTab

```






```{r, data wrangling for lmm for all species, include = TRUE}


# indexMatrix <- vpiData2 %>% 
#   filter(!class %in% c("Bare Substrate")) %>% 
#   select(Site, timePoint, species, class, totalCount) %>% 
#   group_by(Site, timePoint, species, class) %>%
#   # dplyr::summarise(totalCount = sum(count)) %>%
#   na.omit(class)


indexMat <- vpiMat %>% 
  select(-c(`Bare Substrate`))

richness <- specnumber(indexMat)  # Count of non-zero species per row
print(richness)


shannon <- diversity(indexMat, index = "shannon")  # Shannon index (H')
evenness <- shannon / log(richness)  # Pielou's evenness (J')

simpson <- diversity(indexMat, index = "simpson")
print(simpson)

inv_simpson <- diversity(indexMat, index = "invsimpson")
print(inv_simpson)



diversityDF <- data.frame(
  Sample = rownames(indexMat),  # Keep row names
  Richness = richness,
  Shannon = shannon,
  Simpson = simpson,
  InvSimpson = inv_simpson,
  Evenness = evenness,
  row.names = rownames(indexMat)  # Assign row names back
) %>% 
  separate(col = Sample, into = c("site", "timePoint", "species"), sep = "_", remove = FALSE) %>% 
  mutate(across(c(site, timePoint, species), as.factor))



indexSummary <- diversityDF %>% 
  group_by(timePoint, species) %>% 
  dplyr::summarize(meanRichness = mean(Richness),
            meanShannon = mean(Shannon), 
            meanEvenness = mean(Evenness))

```




```{r, richness LMM and Table for all species, include = TRUE}
set.seed(999)

# Fit the linear mixed-effects model for Richness
richness_lmm <- lmer(Richness ~ timePoint + species + (1 | site), data = diversityDF)

# Get the summary of the model
richnessSum <- summary(richness_lmm)

# Extract fixed effects from the model summary
fixed_effects <- richnessSum$coefficients

# Check the actual structure of the fixed effects
print(fixed_effects)

# Assuming column names in fixed_effects are: "Estimate", "Std.Error", "t value", and "Pr(>|t|)"

# Convert the fixed effects to tibble and format
richness_tab <- as_tibble(fixed_effects, rownames = "Comparison") %>%
  dplyr::rename(Estimate = `Estimate`, Std.Error = `Std. Error`, t.value = `t value`, p.value = `Pr(>|t|)`) %>%
  select(Comparison, Estimate, Std.Error, t.value, p.value) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  # mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
  mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>%
  mutate_if(is.character, str_replace_all, pattern = "-", replacement = "–")

# Manually add factor names to the 'Comparison' column (e.g., "timePoint", "species")
richness_tab$Comparison <- c("Intercept", "Time Point:baseline", "Species:APAL")

# Print the updated table
print(richness_tab)

# Create the flextable for Richness
richness_flextable <- richness_tab %>%
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>%
  flextable::compose(part = "header", j = "Estimate", value = as_paragraph("Estimate")) %>%
  flextable::compose(part = "header", j = "Std.Error", value = as_paragraph("Std. Error")) %>%
  flextable::compose(part = "header", j = "t.value", value = as_paragraph("t value")) %>%
  flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%
  align(align = 'center', part = "footer")

# View the flextable for Richness
richness_flextable

# Save the table to a Word document
richnessDoc <- read_docx()  
richnessDoc <- body_add_flextable(richnessDoc, value = richness_flextable)  
print(richnessDoc, target = "../tables/richnessTable.docx")



```

```{r, shannon for all species, include = TRUE}
set.seed(999)

# Fit the linear mixed-effects model for shannon
shannon_lmm <- lmer(Shannon ~ timePoint + species + (1 | site), data = diversityDF)

# Get the summary of the model
shannonSum <- summary(shannon_lmm)

# Extract fixed effects from the model summary
fixed_effects <- shannonSum$coefficients

# Check the actual structure of the fixed effects
print(fixed_effects)

# Assuming column names in fixed_effects are: "Estimate", "Std.Error", "t value", and "Pr(>|t|)"

# Convert the fixed effects to tibble and format
shannon_tab <- as_tibble(fixed_effects, rownames = "Comparison") %>%
  dplyr::rename(Estimate = `Estimate`, Std.Error = `Std. Error`, t.value = `t value`, p.value = `Pr(>|t|)`) %>%
  select(Comparison, Estimate, Std.Error, t.value, p.value) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  # mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
  mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>%
  mutate_if(is.character, str_replace_all, pattern = "-", replacement = "–")

# Manually add factor names to the 'Comparison' column (e.g., "timePoint", "species")
shannon_tab$Comparison <- c("Intercept", "Time Point:baseline", "Species:APAL")

# Print the updated table
print(shannon_tab)

# Create the flextable for shannon
shannon_flextable <- shannon_tab %>%
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>%
  flextable::compose(part = "header", j = "Estimate", value = as_paragraph("Estimate")) %>%
  flextable::compose(part = "header", j = "Std.Error", value = as_paragraph("Std. Error")) %>%
  flextable::compose(part = "header", j = "t.value", value = as_paragraph("t value")) %>%
  flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%
  align(align = 'center', part = "footer")

# View the flextable for shannon
shannon_flextable

# Save the table to a Word document
shannonDoc <- read_docx()  
shannonDoc <- body_add_flextable(shannonDoc, value = shannon_flextable)  
print(shannonDoc, target = "../tables/shannonTable.docx")
```




```{r, Simpson for all species, include = TRUE}
set.seed(999)
# Fit the linear mixed-effects model for simpson
simpson_lmm <- lmer(Simpson ~ timePoint + species + (1 | site), data = diversityDF)

# Get the summary of the model
simpsonSum <- summary(simpson_lmm)

# Extract fixed effects from the model summary
fixed_effects <- simpsonSum$coefficients

# Check the actual structure of the fixed effects
print(fixed_effects)

# Assuming column names in fixed_effects are: "Estimate", "Std.Error", "t value", and "Pr(>|t|)"

# Convert the fixed effects to tibble and format
simpson_tab <- as_tibble(fixed_effects, rownames = "Comparison") %>%
  dplyr::rename(Estimate = `Estimate`, Std.Error = `Std. Error`, t.value = `t value`, p.value = `Pr(>|t|)`) %>%
  select(Comparison, Estimate, Std.Error, t.value, p.value) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  # mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
  mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>%
  mutate_if(is.character, str_replace_all, pattern = "-", replacement = "–")

# Manually add factor names to the 'Comparison' column (e.g., "timePoint", "species")
simpson_tab$Comparison <- c("Intercept", "Time Point:baseline", "Species:APAL")

# Print the updated table
print(simpson_tab)

# Create the flextable for simpson
simpson_flextable <- simpson_tab %>%
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>%
  flextable::compose(part = "header", j = "Estimate", value = as_paragraph("Estimate")) %>%
  flextable::compose(part = "header", j = "Std.Error", value = as_paragraph("Std. Error")) %>%
  flextable::compose(part = "header", j = "t.value", value = as_paragraph("t value")) %>%
  flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%
  align(align = 'center', part = "footer")

# View the flextable for simpson
simpson_flextable

# Save the table to a Word document
simpsonDoc <- read_docx()  
simpsonDoc <- body_add_flextable(simpsonDoc, value = simpson_flextable)  
print(simpsonDoc, target = "../tables/simpsonTable.docx")
```

```{r, evenness for all species, include = TRUE}
set.seed(999)
# Fit the linear mixed-effects model for evenness
evenness_lmm <- lmer(Evenness ~ timePoint + species + (1 | site), data = diversityDF)

# Get the summary of the model
evennessSum <- summary(evenness_lmm)

# Extract fixed effects from the model summary
fixed_effects <- evennessSum$coefficients

# Check the actual structure of the fixed effects
print(fixed_effects)

# Assuming column names in fixed_effects are: "Estimate", "Std.Error", "t value", and "Pr(>|t|)"

# Convert the fixed effects to tibble and format
evenness_tab <- as_tibble(fixed_effects, rownames = "Comparison") %>%
  dplyr::rename(Estimate = `Estimate`, Std.Error = `Std. Error`, t.value = `t value`, p.value = `Pr(>|t|)`) %>%
  select(Comparison, Estimate, Std.Error, t.value, p.value) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  # mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
  mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>%
  mutate_if(is.character, str_replace_all, pattern = "-", replacement = "–")

# Manually add factor names to the 'Comparison' column (e.g., "timePoint", "species")
evenness_tab$Comparison <- c("Intercept", "Time Point:baseline", "Species:APAL")

# Print the updated table
print(evenness_tab)

# Create the flextable for evenness
evenness_flextable <- evenness_tab %>%
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>%
  flextable::compose(part = "header", j = "Estimate", value = as_paragraph("Estimate")) %>%
  flextable::compose(part = "header", j = "Std.Error", value = as_paragraph("Std. Error")) %>%
  flextable::compose(part = "header", j = "t.value", value = as_paragraph("t value")) %>%
  flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%
  align(align = 'center', part = "footer")

# View the flextable for evenness
evenness_flextable

# Save the table to a Word document
evennessDoc <- read_docx()  
evennessDoc <- body_add_flextable(evennessDoc, value = evenness_flextable)  
print(evennessDoc, target = "../tables/evennessTable.docx")



```


```{r, data wrangling for lmm for just coral, include = TRUE}

indexMatCoral <- vpiMat %>% 
  select(-c(`Bare Substrate`, `Cnidaria`, Chordata, `Gorgonia ventalina`, Halimeda, Porifera, Octocorallia, Palythoa, `Turf algae`))





richnessCoral <- specnumber(indexMatCoral)  # Count of non-zero species per row
print(richnessCoral)


shannonCoral <- diversity(indexMatCoral, index = "shannon")  # Shannon index (H')
evennessCoral <- shannonCoral / log(richnessCoral)  # Pielou's evenness (J')

simpsonCoral <- diversity(indexMatCoral, index = "simpson")
print(simpsonCoral)

inv_simpsonCoral <- diversity(indexMatCoral, index = "invsimpson")
print(inv_simpsonCoral)


diversityDFCoral <- data.frame(
  Sample = rownames(indexMatCoral),  # Keep row names
  Richness = richnessCoral,
  Shannon = shannonCoral,
  Simpson = simpsonCoral,
  InvSimpson = inv_simpsonCoral,
  Evenness = evennessCoral,
  row.names = rownames(indexMat)  # Assign row names back
) %>% 
  separate(col = Sample, into = c("site", "timePoint", "species"), sep = "_", remove = FALSE) %>% 
  mutate(across(c(site, timePoint, species), as.factor))



indexSummaryCoral<- diversityDFCoral %>% 
  group_by(timePoint, species) %>% 
  dplyr::summarize(meanRichness = mean(Richness),
            meanShannon = mean(Shannon), 
            meanEvenness = mean(Evenness))

```




```{r, richness LMM and Table for just coral, include = TRUE}
set.seed(999)

# Fit the linear mixed-effects model for Richness
richness_lmmCoral <- lmer(Richness ~ timePoint + species + (1 | site), data = diversityDFCoral)

# Get the summary of the model
richnessSumCoral <- summary(richness_lmmCoral)

# Extract fixed effects from the model summary
fixed_effects <- richnessSumCoral$coefficients

# Check the actual structure of the fixed effects
print(fixed_effects)

# Assuming column names in fixed_effects are: "Estimate", "Std.Error", "t value", and "Pr(>|t|)"

# Convert the fixed effects to tibble and format
richness_tabCoral <- as_tibble(fixed_effects, rownames = "Comparison") %>%
  dplyr::rename(Estimate = `Estimate`, Std.Error = `Std. Error`, t.value = `t value`, p.value = `Pr(>|t|)`) %>%
  select(Comparison, Estimate, Std.Error, t.value, p.value) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  # mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
  mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>%
  mutate_if(is.character, str_replace_all, pattern = "-", replacement = "–")

# Manually add factor names to the 'Comparison' column (e.g., "timePoint", "species")
richness_tabCoral$Comparison <- c("Intercept", "Time Point:baseline", "Species:APAL")

# Print the updated table
print(richness_tabCoral)

# Create the flextable for Richness
richness_flextableCoral <- richness_tabCoral %>%
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>%
  flextable::compose(part = "header", j = "Estimate", value = as_paragraph("Estimate")) %>%
  flextable::compose(part = "header", j = "Std.Error", value = as_paragraph("Std. Error")) %>%
  flextable::compose(part = "header", j = "t.value", value = as_paragraph("t value")) %>%
  flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%
  align(align = 'center', part = "footer")

# View the flextable for Richness
richness_flextableCoral

# Save the table to a Word document
richnessDocCoral <- read_docx()  
richnessDocCoral <- body_add_flextable(richnessDocCoral, value = richness_flextableCoral)  
print(richnessDocCoral, target = "../tables/richnessTableCoral.docx")



```

```{r, shannon for just coral, include = TRUE}
set.seed(999)

# Fit the linear mixed-effects model for shannon
shannon_lmmCoral <- lmer(Shannon ~ timePoint + species + (1 | site), data = diversityDFCoral)

# Get the summary of the model
shannonSumCoral <- summary(shannon_lmmCoral)

# Extract fixed effects from the model summary
fixed_effects <- shannonSumCoral$coefficients

# Check the actual structure of the fixed effects
print(fixed_effects)

# Assuming column names in fixed_effects are: "Estimate", "Std.Error", "t value", and "Pr(>|t|)"

# Convert the fixed effects to tibble and format
shannon_tabCoral <- as_tibble(fixed_effects, rownames = "Comparison") %>%
  dplyr::rename(Estimate = `Estimate`, Std.Error = `Std. Error`, t.value = `t value`, p.value = `Pr(>|t|)`) %>%
  select(Comparison, Estimate, Std.Error, t.value, p.value) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  # mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
  mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>%
  mutate_if(is.character, str_replace_all, pattern = "-", replacement = "–")

# Manually add factor names to the 'Comparison' column (e.g., "timePoint", "species")
shannon_tabCoral$Comparison <- c("Intercept", "Time Point:baseline", "Species:APAL")

# Print the updated table
print(shannon_tabCoral)

# Create the flextable for shannon
shannon_flextableCoral <- shannon_tabCoral %>%
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>%
  flextable::compose(part = "header", j = "Estimate", value = as_paragraph("Estimate")) %>%
  flextable::compose(part = "header", j = "Std.Error", value = as_paragraph("Std. Error")) %>%
  flextable::compose(part = "header", j = "t.value", value = as_paragraph("t value")) %>%
  flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%
  align(align = 'center', part = "footer")

# View the flextable for shannon
shannon_flextableCoral

# Save the table to a Word document
shannonDocCoral <- read_docx()  
shannonDocCoral <- body_add_flextable(shannonDocCoral, value = shannon_flextableCoral)  
print(shannonDocCoral, target = "../tables/shannonTableCoral.docx")
```




```{r, Simpson for just coral, include = TRUE}
set.seed(999)
# Fit the linear mixed-effects model for simpson
simpson_lmmCoral <- lmer(Simpson ~ timePoint + species + (1 | site), data = diversityDFCoral)

# Get the summary of the model
simpsonSumCoral <- summary(simpson_lmmCoral)

# Extract fixed effects from the model summary
fixed_effects <- simpsonSumCoral$coefficients

# Check the actual structure of the fixed effects
print(fixed_effects)

# Assuming column names in fixed_effects are: "Estimate", "Std.Error", "t value", and "Pr(>|t|)"

# Convert the fixed effects to tibble and format
simpson_tabCoral <- as_tibble(fixed_effects, rownames = "Comparison") %>%
  dplyr::rename(Estimate = `Estimate`, Std.Error = `Std. Error`, t.value = `t value`, p.value = `Pr(>|t|)`) %>%
  select(Comparison, Estimate, Std.Error, t.value, p.value) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  # mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
  mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>%
  mutate_if(is.character, str_replace_all, pattern = "-", replacement = "–")

# Manually add factor names to the 'Comparison' column (e.g., "timePoint", "species")
simpson_tabCoral$Comparison <- c("Intercept", "Time Point:baseline", "Species:APAL")

# Print the updated table
print(simpson_tabCoral)

# Create the flextable for simpson
simpson_flextableCoral <- simpson_tabCoral %>%
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>%
  flextable::compose(part = "header", j = "Estimate", value = as_paragraph("Estimate")) %>%
  flextable::compose(part = "header", j = "Std.Error", value = as_paragraph("Std. Error")) %>%
  flextable::compose(part = "header", j = "t.value", value = as_paragraph("t value")) %>%
  flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%
  align(align = 'center', part = "footer")

# View the flextable for simpson
simpson_flextableCoral

# Save the table to a Word document
simpsonDocCoral <- read_docx()  
simpsonDocCoral <- body_add_flextable(simpsonDocCoral, value = simpson_flextableCoral)  
print(simpsonDoc, target = "../tables/simpsonTableCoral.docx")
```

```{r, evenness for just coral, include = TRUE}
set.seed(999)
# Fit the linear mixed-effects model for evenness
evenness_lmmCoral <- lmer(Evenness ~ timePoint + species + (1 | site), data = diversityDFCoral)

# Get the summary of the model
evennessSumCoral <- summary(evenness_lmmCoral)

# Extract fixed effects from the model summary
fixed_effects <- evennessSumCoral$coefficients

# Check the actual structure of the fixed effects
print(fixed_effects)

# Assuming column names in fixed_effects are: "Estimate", "Std.Error", "t value", and "Pr(>|t|)"

# Convert the fixed effects to tibble and format
evenness_tabCoral <- as_tibble(fixed_effects, rownames = "Comparison") %>%
  dplyr::rename(Estimate = `Estimate`, Std.Error = `Std. Error`, t.value = `t value`, p.value = `Pr(>|t|)`) %>%
  select(Comparison, Estimate, Std.Error, t.value, p.value) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  # mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
  mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>%
  mutate_if(is.character, str_replace_all, pattern = "-", replacement = "–")

# Manually add factor names to the 'Comparison' column (e.g., "timePoint", "species")
evenness_tabCoral$Comparison <- c("Intercept", "Time Point:baseline", "Species:APAL")

# Print the updated table
print(evenness_tabCoral)

# Create the flextable for evenness
evenness_flextableCoral <- evenness_tabCoral %>%
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>%
  flextable::compose(part = "header", j = "Estimate", value = as_paragraph("Estimate")) %>%
  flextable::compose(part = "header", j = "Std.Error", value = as_paragraph("Std. Error")) %>%
  flextable::compose(part = "header", j = "t.value", value = as_paragraph("t value")) %>%
  flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%
  align(align = 'center', part = "footer")

# View the flextable for evenness
evenness_flextableCoral

# Save the table to a Word document
evennessDocCoral <- read_docx()  
evennessDocCoral <- body_add_flextable(evennessDocCoral, value = evenness_flextableCoral)  
print(evennessDocCoral, target = "../tables/evennessTableCoral.docx")



```


```{r}
meanAcer <- ACER %>% 
  filter(class %in% "Acropora cervicornis") %>%
  group_by(timePoint) %>% 
  dplyr::summarize(meanAbundance = mean(abundance))

indexSummaryTabCoral <- indexSummaryCoral %>% 
  flextable() %>% 
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%
  align(align = 'center', part = "footer")

indexSummaryDocCoral <- read_docx()  
indexSummaryDocCoral <- body_add_flextable(indexSummaryDocCoral, value = indexSummaryTabCoral)  
print(indexSummaryDocCoral, target = "../tables/indexSummaryTabCoral.docx")





```














